"use strict";sap.ui.define(["sap/ui/base/ManagedObject","./Util","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/core/library","sap/base/Log","../enums","cc/spreadsheetimporter/v1_1_1/thirdparty/xlsx"],function(e,t,s,o,r,a,n,i){"use strict";function l(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}const d=l(t);const p=r["MessageType"];const c=n["CustomMessageTypes"];const u=e.extend("cc.spreadsheetimporter.v1_1_1.MessageHandler",{constructor:function t(s){e.prototype.constructor.call(this);this.messages=[];this.messages=[];this.spreadsheetUploadController=s},setMessages:function e(t){this.messages=t},addArrayToMessages:function e(t){a.debug("addArrayToMessages",undefined,"SpreadsheetUpload: MessageHandler",()=>this.spreadsheetUploadController.component.logger.returnObject(t));this.messages=this.messages.concat(t)},addMessageToMessages:function e(t){a.debug("addMessageToMessages",undefined,"SpreadsheetUpload: MessageHandler",()=>this.spreadsheetUploadController.component.logger.returnObject(t));this.messages.push(t)},getMessages:function e(){return this.messages},checkDuplicateColumns:function e(t){const s=t.filter((e,s)=>t.indexOf(e)!==s);if(s.length>0){const e={title:this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.duplicateColumns",[s.join(", ")]),type:c.DuplicateColumns,ui5type:p.Error,group:false};this.addMessageToMessages(e)}},checkMandatoryColumns:function e(t,s,o,r,a){const n=[...new Set([...o,...r])];this.checkMandatoryFields(t,n,a)},checkMandatoryFields:function e(t,s,o){if(!s){return}for(const e of s){const s=o.get(e)?.label;if(!s){a.error(`Mandatory Field ${e} not found for checking mandatory fields`,undefined,"SpreadsheetUpload: MessageHandler");continue}for(const[o,r]of t.entries()){const t=d.getValueFromRow(r,s,e,this.spreadsheetUploadController.component.getFieldMatchType());const a={title:this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.mandatoryFieldNotFilled",[s]),type:c.MandatoryFieldNotFilled,row:o+2,counter:1,ui5type:p.Error};if(!t||t.rawValue===""||t.rawValue===undefined){this.addMessageToMessages(a)}}}},checkFormat:function e(t){for(const[e,s]of t.entries()){Object.values(s).forEach(t=>{let{sheetDataType:s,format:o,rawValue:r,formattedValue:a}=t;if(s==="n"&&o!=="General"&&r!==Number(a)){const t={title:"Format",type:c.Formatting,row:e+2,counter:1,ui5type:p.Warning,rawValue:r,formattedValue:a};this.addMessageToMessages(t)}})}},checkMaxLength:function e(t,s,o){for(const[e,o]of t.entries()){for(const[t,r]of s){if(r.maxLength){const s=d.getValueFromRow(o,r.label,t,this.spreadsheetUploadController.component.getFieldMatchType());if(s&&s.rawValue&&s.rawValue.length>r.maxLength){const t=s.rawValue.length-r.maxLength;const o={title:this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.maxLengthExceeded",[r.maxLength,r.label]),type:c.MaxLengthExceeded,row:e+2,counter:1,ui5type:p.Error,rawValue:s.rawValue,maxLength:r.maxLength,excededLength:t};this.addMessageToMessages(o)}}}}},checkColumnNames:function e(t,s,o){for(let e=0;e<t.length;e++){const r=t[e];let a=false;for(const[e,t]of o){if(s==="label"){if(t.label===r){a=true;break}}if(s==="labelTypeBrackets"){if(r.includes(`[${e}]`)){a=true;break}}}if(!a){const e={title:this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.columnNotFound",[r]),type:c.ColumnNotFound,counter:1,ui5type:p.Error};this.addMessageToMessages(e)}}},checkKeyColumns:function e(t,s,o){const r=[];for(let e=0;e<s.length;e++){const a=s[e];let n=false;for(const e in t){if(t[e].includes(`[${a}]`)){n=true;r.push(a);break}}if(!n){const e=o.get(a)?.label?o.get(a).label:a;const t={title:this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.keyColumnNotFound",[e]),type:c.ColumnNotFound,counter:1,ui5type:p.Error};this.addMessageToMessages(t)}}return r},areMessagesPresent:function e(){if(this.messages.some(e=>e.counter>0)){return true}return false},displayMessages:async function e(t){this.messageDialog=await s.load({name:"cc.spreadsheetimporter.v1_1_1.fragment.MessagesDialog",type:"XML",controller:this});this.messageDialog.setModel(this.spreadsheetUploadController.componentI18n,"i18n");this.messageDialog.setModel(new o,"messages");const r=this.groupMessages(this.messages);const n=this.sortMessagesByTitle(r);a.debug("sortedMessagesGrouped",undefined,"SpreadsheetUpload: MessageHandler",()=>this.spreadsheetUploadController.component.logger.returnObject({sortedMessagesGrouped:n}));this.messageDialog.getModel("messages").setData(n);const i=this.getWorstType(n);const l=new o({strict:this.spreadsheetUploadController.component.getStrict(),strictParameter:t,dialogState:i});this.messageDialog.setModel(l,"info");this.messageDialog.open()},groupMessages:function e(t){const s=t.filter(e=>e.counter!==0);const o=s.filter(e=>e.type.group===true);const r=o.reduce((e,t)=>{let s="";if(!e[t.title]){e[t.title]=[]}if(t.maxLength&&t.excededLength){s=this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.maxLengthExceededWithLength",[t.maxLength,t.excededLength,t.rawValue])}else if(t.rawValue&&t.formattedValue){s=this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.errorInRowWithValueFormatted",[t.row,t.formattedValue,t.rawValue])}else if(t.rawValue){s=this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.errorInRowWithValue",[t.row,t.rawValue])}else{s=this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.errorInRow",[t.row])}e[t.title].push({description:s,row:t.row});return e},{});const a=[];for(const e in r){const s=r[e];const o=t.find(t=>t.title===e)?.ui5type||"";a.push({title:e,description:s.map(e=>e.description).join("\n"),ui5type:o,details:s})}const n=a.concat(s.filter(e=>e.type.group===false));return n},onCloseMessageDialog:function e(){this.messageDialog.close();this.messageDialog.destroy();this.spreadsheetUploadController.resetContent()},onContinue:function e(){this.messageDialog.close();const t=this.spreadsheetUploadController.getSpreadsheetUploadDialog();const s=this.spreadsheetUploadController.payloadArray.length;t.getModel("info").setProperty("/dataRows",s)},onDownloadErrors:function e(){const t=this.messageDialog.getModel("messages").getData();const s={title:this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.messageTitle"),description:this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.messageDescription"),ui5type:this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.messageType"),rowNumber:this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.messageRow")};const o=[{wch:60},{wch:40},{wch:15},{wch:20}];const r=[];t.forEach(e=>{if(e.details?.length>0){e.details?.forEach(t=>{const o={};for(const r in s){if(r==="description"){o[s[r]]=t.description}else if(r==="rowNumber"){o[s[r]]=t.row}else if(e.hasOwnProperty(r)){o[s[r]]=e[r]}}r.push(o)})}else{const t={};for(const o in s){if(o==="description"){t[s[o]]=e.title}else if(o==="rowNumber"){t[s[o]]=e.row}else if(e.hasOwnProperty(o)){t[s[o]]=e[o]}}r.push(t)}});const a=i.utils.json_to_sheet(r);a["!cols"]=o;const n=i.utils.book_new();i.utils.book_append_sheet(n,a,this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.sheetName"));i.writeFile(n,this.spreadsheetUploadController.util.geti18nText("spreadsheetimporter.spreadsheetFilenameName")+".xlsx")},sortMessagesByTitle:function e(t){return t.sort((e,t)=>{if(e.title<t.title){return-1}if(e.title>t.title){return 1}return 0})},getWorstType:function e(t){let s=p.None;const o={[p.None]:0,[p.Information]:1,[p.Success]:2,[p.Warning]:3,[p.Error]:4};for(const e of t){if(o[e.ui5type]>o[s]){s=e.ui5type}}return s}});return u});
//# sourceMappingURL=MessageHandler.js.map