"use strict";sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/core/Fragment","sap/m/MessageToast","../Preview","../Util","cc/spreadsheetimporter/v1_1_1/thirdparty/xlsx","./OptionsDialog","sap/base/Log","../SheetHandler","../Parser","sap/m/Button","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Select","sap/ui/core/Item"],function(e,t,s,o,a,r,n,l,i,h,p,d,c,u,g){"use strict";function m(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}const f=m(o);const y=m(a);const w=m(n);const S=m(i);const U=m(h);const D=e.extend("cc.spreadsheetimporter.v1_1_1.SpreadsheetUploadDialog",{constructor:function t(s,o,a,r){e.prototype.constructor.call(this);this.spreadsheetUploadController=s;this.component=o;this.componentI18n=a;this.util=new y(a.getResourceBundle());this.previewHandler=new f(this.util);this.optionsHandler=new w(s);this.messageHandler=r},createSpreadsheetUploadDialog:async function e(){if(!this.spreadsheetUploadDialog){this.spreadsheetOptionsModel=new d({dataRows:0,strict:this.component.getStrict(),hidePreview:this.component.getHidePreview(),showOptions:this.component.getShowOptions(),hideGenerateTemplateButton:false,fileUploadValue:"",densityClass:this.component._densityClass});this.spreadsheetUploadDialog=await t.load({name:"cc.spreadsheetimporter.v1_1_1.fragment.SpreadsheetUpload",type:"XML",controller:this});this.spreadsheetUploadDialog.setComponent(this.component);this.spreadsheetUploadDialog.setBusyIndicatorDelay(0);this.spreadsheetUploadDialog.setModel(this.componentI18n,"i18n");this.spreadsheetUploadDialog.setModel(this.spreadsheetOptionsModel,"info");this.spreadsheetUploadDialog.setModel(this.component.getModel("device"),"device");this.spreadsheetUploadDialog.attachDecimalSeparatorChanged(this.onDecimalSeparatorChanged.bind(this));this.spreadsheetUploadDialog.attachAvailableOptionsChanged(this.onAvailableOptionsChanged.bind(this));this.spreadsheetUploadDialog.attachFileDrop(this.onFileDrop.bind(this))}if(this.component.getStandalone()&&this.component.getColumns().length===0){this.spreadsheetOptionsModel.setProperty("/hideGenerateTemplateButton",true)}},onFileDrop:function e(t){const s=t.getParameter("files");const o=s[0];this.spreadsheetUploadDialog.getModel("info").setProperty("/fileUploadValue",o.name);this.handleFile(o)},onFileUpload:async function e(t){this.messageHandler.setMessages([]);const s=t.getParameter("files")[0];this.handleFile(s)},handleFile:async function e(t){try{this.messageHandler.setMessages([]);const e=await this._readWorkbook(t);const s=this.component.getStandalone();const o=this.component.getReadAllSheets();let a=[];let n=[];if(s&&o){for(const t of Object.keys(e.Sheets)){let s=S.sheet_to_json(e.Sheets[t]);for(const e of s){Object.keys(e).forEach(s=>{e[s].sheetName=t})}a=a.concat(s);n=n.concat(r.utils.sheet_to_json(e.Sheets[t],{header:1})[0])}}else{const t=this.spreadsheetUploadController.component.getReadSheet();let s;try{s=await this._getSheetName(e,t)}catch(e){this.resetContent();return}a=S.sheet_to_json(e.Sheets[s]);n=r.utils.sheet_to_json(e.Sheets[s],{header:1})[0]}if(!a||a.length===0){throw new Error(this.util.geti18nText("spreadsheetimporter.emptySheet"))}for(const e of a){for(const t in e){e[t].rawValue=typeof e[t].rawValue==="string"?e[t].rawValue.trim():e[t].rawValue}}if(!s){this.messageHandler.checkFormat(a);this.messageHandler.checkMandatoryColumns(a,n,this.spreadsheetUploadController.odataKeyList,this.component.getMandatoryFields(),this.spreadsheetUploadController.typeLabelList);this.messageHandler.checkDuplicateColumns(n);if(!this.component.getSkipMaxLengthCheck()){this.messageHandler.checkMaxLength(a,this.spreadsheetUploadController.typeLabelList,this.component.getFieldMatchType())}if(!this.component.getSkipColumnsCheck()){this.messageHandler.checkColumnNames(n,this.component.getFieldMatchType(),this.spreadsheetUploadController.typeLabelList)}}this.spreadsheetUploadController.payload=a;this.spreadsheetUploadController.payloadArray=s?this.spreadsheetUploadController.payload:U.parseSpreadsheetData(this.spreadsheetUploadController.payload,this.spreadsheetUploadController.typeLabelList,this.component,this.messageHandler,this.util,this.spreadsheetUploadController.isODataV4);this.getDialog().setBusy(true);try{await y.fireEventAsync("checkBeforeRead",{sheetData:a,parsedData:this.spreadsheetUploadController.payloadArray},this.component)}catch(e){l.error("Error while calling the checkBeforeRead event",e,"SpreadsheetUpload: onFileUpload")}this.getDialog().setBusy(false);if(this.messageHandler.areMessagesPresent()){this.messageHandler.displayMessages();return}this.setDataRows(this.spreadsheetUploadController.payloadArray.length)}catch(e){y.showError(e,"SpreadsheetUpload.ts","onFileUpload");this.resetContent()}},onUploadSet:async function e(t){const o=t.getSource();this.getDialog().setBusy(true);let a;let r;try{a=await y.fireEventAsync("uploadButtonPress",{payload:this.spreadsheetUploadController.payloadArray,rawData:this._extractRawValues(this.spreadsheetUploadController.payloadArray),parsedData:this._extractParsedValues(this.spreadsheetUploadController.payloadArray)},this.component);r=a.bPreventDefault}catch(e){}this.getDialog().setBusy(false);if(r||this.component.getStandalone()){this.onCloseDialog();if(this.messageHandler.areMessagesPresent()){this.messageHandler.displayMessages(true)}return}if(!this.spreadsheetUploadController.payloadArray.length){s.show(this.util.geti18nText("spreadsheetimporter.selectFileUpload"));return}var n=this;const i=o.getParent();i.setBusyIndicatorDelay(0);i.setBusy(true);await y.sleep(50);var h=function(){return new Promise((e,t)=>{n.spreadsheetUploadController.getODataHandler().callOdata(e,t,n.spreadsheetUploadController)})};var p={busy:{set:true,check:false},dataloss:{popup:false,navigation:false},sActionLabel:this.util.geti18nText("spreadsheetimporter.uploadingFile")};if(this.spreadsheetUploadController.isODataV4){try{await this.spreadsheetUploadController.context.editFlow.securedExecution(h,p)}catch(e){l.error("Error while calling the odata service",e,"SpreadsheetUpload: onUploadSet")}}else{try{if(this.spreadsheetUploadController.context.extensionAPI){await this.spreadsheetUploadController.context.extensionAPI.securedExecution(h,p)}else{await h()}}catch(e){l.error("Error while calling the odata service",e,"SpreadsheetUpload: onUploadSet");this.spreadsheetUploadController.errorsFound=true;this.resetContent()}}i.setBusy(false);this.getDialog().setBusy(true);try{await y.fireEventAsync("requestCompleted",{success:!this.spreadsheetUploadController.errorsFound},this.component)}catch(e){l.error("Error while calling the requestCompleted event",e,"SpreadsheetUpload: onUploadSet")}this.getDialog().setBusy(false);this.onCloseDialog()},openSpreadsheetUploadDialog:function e(){this.spreadsheetUploadDialog.open()},onCloseDialog:function e(){this.component.fireRequestCompleted();this.resetContent();this.spreadsheetUploadDialog.close()},onDecimalSeparatorChanged:function e(t){this.component.setDecimalSeparator(t.getParameter("decimalSeparator"))},onAvailableOptionsChanged:function e(t){const s=t.getParameter("availableOptions");if(s.length>0){this.component.setShowOptions(true);this.spreadsheetOptionsModel.setProperty("/showOptions",true)}else{this.component.setShowOptions(false);this.spreadsheetOptionsModel.setProperty("/showOptions",true)}this.component.setAvailableOptions(s)},resetContent:function e(){this.spreadsheetUploadDialog.getModel("info").setProperty("/dataRows",0);var t=this.spreadsheetUploadDialog.getContent()[0].getItems()[1];t.setValue()},setDataRows:function e(t){this.spreadsheetUploadDialog.getModel("info").setProperty("/dataRows",t)},getDialog:function e(){return this.spreadsheetUploadDialog},showPreview:async function e(){this.previewHandler.showPreview(this.spreadsheetUploadController.getPayloadArray(),this.spreadsheetUploadController.typeLabelList,this.component.getPreviewColumns())},onTempDownload:async function e(){if(this.component.getSpreadsheetTemplateFile()!==""){try{const e=this.component.getSpreadsheetTemplateFile();let t;let s;if(typeof e==="string"){if(e.startsWith("http://")||e.startsWith("https://")){const o=await fetch(e);if(!o.ok){throw new Error("Network response was not ok "+o.statusText)}s=e.split("/").pop();t=await o.arrayBuffer()}else{const o=sap.ui.require.toUrl(e);const a=await fetch(o);if(!a.ok){throw new Error("Network response was not ok "+a.statusText)}s=e.split("/").pop();t=await a.arrayBuffer()}}else if(e instanceof ArrayBuffer){t=e}else{throw new Error("Unsupported type for templateFile")}if(this.component.getSpreadsheetFileName()!=="Template.xlsx"||s===undefined){s=this.component.getSpreadsheetFileName()}y.downloadSpreadsheetFile(t,s)}catch(e){}}else{let e=this.component.getFieldMatchType();var t={};let o=[];let a=this.component.getSampleData();let n=true;if(!a||a.length===0){n=false;a=[{}]}const l=15;const i=20;let h=0;let p=1;if(this.component.getStandalone()){for(let e of this.component.getColumns()){t[r.utils.encode_cell({c:h,r:0})]={v:e,t:"s"};h++}h=0;for(let e of this.component.getColumns()){for(const[s,o]of a.entries()){let a;p=s+1;if(o[e]){a=o[e];t[r.utils.encode_cell({c:h,r:1})]={v:a,t:"s"}}}h++}}else{for(let[s,d]of this.spreadsheetUploadController.typeLabelList.entries()){let c={v:"",t:"s"};let u="";if(e==="label"){u=d.label}if(e==="labelTypeBrackets"){u=`${d.label}[${s}]`}t[r.utils.encode_cell({c:h,r:0})]={v:u,t:"s"};for(const[e,u]of a.entries()){let a;p=e+1;if(u[s]){a=u[s]}if(d.type==="Edm.Boolean"){let e=n?"":"true";a=a?a.toString():e;c={v:a,t:"b"};o.push({wch:l})}else if(d.type==="Edm.String"){let e;if(d.maxLength){e=a?a:"test string".substring(0,d.maxLength)}else{e=a?a:"test string"}let t=n?"":e;a=a?a:t;c={v:a,t:"s"};o.push({wch:l})}else if(d.type==="Edm.DateTimeOffset"||d.type==="Edm.DateTime"){let e;const t=await this.getLanguage();if(t.startsWith("en")){e="mm/dd/yyyy hh:mm AM/PM"}else{e="dd.mm.yyyy hh:mm"}let s=n?"":new Date;a=a?a:s;let r=a?"d":"s";c={v:a,t:r,z:e};o.push({wch:i})}else if(d.type==="Edm.Date"){let e=n?"":new Date;a=a?a.toString():e;let t=a?"d":"s";c={v:a,t:t};o.push({wch:l})}else if(d.type==="Edm.TimeOfDay"||d.type==="Edm.Time"){let e=n?"":new Date;a=a?a:e;let t=a?"d":"s";c={v:a,t:t,z:"hh:mm"};o.push({wch:l})}else if(d.type==="Edm.UInt8"||d.type==="Edm.Int16"||d.type==="Edm.Int32"||d.type==="Edm.Integer"||d.type==="Edm.Int64"||d.type==="Edm.Integer64"){let e=n?"":85;a=a?a:e;c={v:a,t:"n"};o.push({wch:l})}else if(d.type==="Edm.Double"||d.type==="Edm.Decimal"){const e=this.component.getDecimalSeparator();let t=n?"":`123${e}4`;a=a?a.toString():t;c={v:a,t:"n"};o.push({wch:l})}if(!this.component.getHideSampleData()){t[r.utils.encode_cell({c:h,r:p})]=c}}h++}}t["!ref"]=r.utils.encode_range({s:{c:0,r:0},e:{c:h,r:a.length}});t["!cols"]=o;const d=r.utils.book_new();r.utils.book_append_sheet(d,t,"Tabelle1");r.writeFile(d,this.component.getSpreadsheetFileName());s.show(this.util.geti18nText("spreadsheetimporter.downloadingTemplate"))}},onOpenOptionsDialog:function e(){this.optionsHandler.openOptionsDialog()},_readWorkbook:async function e(t){return new Promise(async(e,s)=>{try{const s=await this.buffer_RS(t.stream());let o=r.read(s,{cellNF:true,cellDates:true,cellText:true,cellFormula:true});e(o)}catch(e){l.error("Error while reading the uploaded workbook",e,"SpreadsheetUpload: _readWorkbook");s(e)}})},buffer_RS:async function e(t){const s=[];const o=t.getReader();for(;;){const e=await o.read();if(e.value)s.push(e.value);if(e.done)break}const a=new Uint8Array(s.reduce((e,t)=>e+t.length,0));let r=0;for(const e of s){a.set(e,r);r+=e.length}return a},_extractRawValues:function e(t){return t.map(e=>{const t={};for(const s in e){if(e[s].hasOwnProperty("rawValue")){t[s]=e[s].rawValue}}return t})},_extractParsedValues:function e(t){return t.map(e=>{const t={};for(const s in e){if(e[s].hasOwnProperty("formattedValue")){t[s]=e[s].formattedValue}}return t})},_getSheetName:async function e(t,s){let o;if(typeof s==="number"){if(s>=0&&s<t.SheetNames.length){o=t.SheetNames[s]}else{l.error("Invalid sheet index, defaulting to first Sheet","SpreadsheetUpload: _getSheetName");o=t.SheetNames[0]}}else if(s==="XXSelectorXX"){if(t.SheetNames.length===1){o=t.SheetNames[0];l.debug("Only one sheet in workbook, defaulting to first Sheet","SpreadsheetUpload: _getSheetName")}else{o=await this._displaySheetSelectorDialog(t.SheetNames)}}else if(t.SheetNames.includes(s)){o=s}else{l.error("Invalid sheet name, defaulting to first Sheet","SpreadsheetUpload: _getSheetName");o=t.SheetNames[0]}return o},_displaySheetSelectorDialog:function e(t){return new Promise((e,s)=>{const o=new u;t.forEach(e=>{o.addItem(new g({key:e,text:e}))});const a=this.componentI18n.getResourceBundle();const r=new c({title:a.getText("spreadsheetimporter.sheetSelectorDialogTitle"),type:"Message",content:[o],beginButton:new p({text:a.getText("spreadsheetimporter.ok"),press:()=>{const t=o.getSelectedKey();e(t);r.close()}}),afterClose:()=>r.destroy(),endButton:new p({text:a.getText("close"),press:()=>{s(new Error(a.getText("close")));r.close()}})});r.open()})},getLanguage:async function e(){try{const e=await y.loadUI5RessourceAsync("sap/base/i18n/Localization");return e.getLanguage()}catch(e){l.debug("sap/base/i18n/Localization not found",undefined,"SpreadsheetUpload: checkForODataErrors")}return sap.ui.getCore().getConfiguration().getLanguage()}});return D});
//# sourceMappingURL=SpreadsheetUploadDialog.js.map